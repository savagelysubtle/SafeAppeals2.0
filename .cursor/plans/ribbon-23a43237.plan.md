<!-- 23a43237-3e96-4ee0-9dd5-303d9164720e d7c2555a-fe78-434e-8a18-3c95e2009204 -->
# Canvas-Based Text Editor with Rulers & Margins

## Scope (per your choices)

- **Rendering**: HTML Canvas API for text rendering (full control)
- **Features**: Basic rulers and margins (left margin, top ruler showing character positions)
- **Integration**: Merge with existing ribbon editor - add canvas/rulers/margins to current implementation
- **Priority**: Change from "option" to "default" so it auto-opens for .txt files
- **Comments**: Add TODO comments in files where complex ribbon features will go later

## Files to Modify

### `extensions/txt-rich-editor/package.json`

- Change `priority: "option"` to `priority: "default"` for .txt files
- Keep .gdoc and .docx as "option" (or remove them from this editor)

### `extensions/txt-rich-editor/src/richTextEditorProvider.ts`

- Add canvas rendering layer below the contenteditable div
- Add ruler component (top) showing character/column positions
- Add margin component (left) showing line numbers
- Update CSS to layer: canvas (bottom) → contenteditable (middle) → ribbon (top)
- Add TODO comments for future complex ribbon features:
  - `// TODO: Add Insert tab (tables, images, shapes)`
  - `// TODO: Add Page Layout tab (page size, orientation, columns)`
  - `// TODO: Add Review tab (track changes, comments)`

### `extensions/txt-rich-editor/src/canvasRenderer.ts` (new)

- `class TextCanvas` - manages canvas rendering
- `renderText()` - draws text content on canvas
- `renderCursor()` - draws blinking cursor
- `renderSelection()` - draws selection highlight
- `syncWithEditor()` - keeps canvas in sync with contenteditable
- Handles font metrics, line wrapping, scrolling

### `extensions/txt-rich-editor/src/rulerManager.ts` (new)

- `class RulerManager` - manages ruler and margin overlays
- `renderTopRuler()` - draws character position ruler
- `renderLeftMargin()` - draws line number margin
- `updateMargins(left, right, top, bottom)` - sets working margins
- `getMarginBounds()` - returns current margin rectangles
- Syncs with canvas scroll position

### `extensions/txt-rich-editor/src/marginController.ts` (new)

- `class MarginController` - enforces text bounds
- `constrainText()` - wraps text at right margin
- `applyIndentation()` - respects left margin
- `calculateLineBreaks()` - determines where text wraps
- Integrates with contenteditable to enforce margins

## Implementation Steps

### 1. Change Priority to Default

Update package.json so .txt files open with our editor by default

### 2. Add Canvas Layer

- Create canvas element positioned absolutely below contenteditable
- Match canvas size to editor viewport
- Handle resize events

### 3. Implement Text Rendering

- Extract text content from contenteditable
- Calculate line positions based on margins
- Draw text on canvas with proper font/size
- Handle scrolling synchronization

### 4. Add Ruler Component

- Fixed position div at top of editor
- Shows character positions (0, 10, 20, 30...)
- Scroll horizontally with content
- Visual indicators for tab stops (future)

### 5. Add Margin Component

- Fixed position div at left of editor
- Shows line numbers
- Scroll vertically with content
- Highlight current line number

### 6. Enforce Margins

- Listen to contenteditable input events
- Wrap text at right margin boundary
- Apply left margin indentation
- Prevent typing beyond margins

### 7. Add TODO Comments

Place comments in ribbon sections for future expansion:

```typescript
// TODO: Complex ribbon - Insert tab
//   - Tables, Images, Shapes, Charts
//   - Links, Bookmarks, Cross-references
//   - Header/Footer, Page Number, Date/Time

// TODO: Complex ribbon - Page Layout tab
//   - Page Size, Orientation, Margins (preset)
//   - Columns, Line Numbers, Hyphenation
//   - Page Background, Watermark

// TODO: Complex ribbon - Review tab
//   - Track Changes, Comments, Compare
//   - Spelling & Grammar, Thesaurus
//   - Protect Document, Accept/Reject Changes
```

## CSS Structure

```css
.editor-container {
  position: relative;
  /* Canvas layer */
  canvas { position: absolute; z-index: 1; }
  /* Text layer */
  .editor { position: relative; z-index: 2; background: transparent; }
  /* Ribbon layer */
  .ribbon { position: relative; z-index: 3; }
}

.ruler-top {
  position: fixed; top: [ribbon-height]; left: [margin-width];
  height: 20px; background: #f0f0f0;
}

.margin-left {
  position: fixed; left: 0; top: [ribbon-height + ruler-height];
  width: 50px; background: #f8f8f8;
}
```

## Margin Defaults

- Left margin: 50px (for line numbers)
- Right margin: 20px (padding from edge)
- Top margin: After ruler (20px ruler + 10px padding)
- Bottom margin: 20px (padding from edge)

## Text Wrapping

- Calculate available width: `viewport - leftMargin - rightMargin`
- Measure text width using canvas `measureText()`
- Break at word boundaries when exceeding available width
- Update contenteditable with `<br>` or block elements

## Keyboard Shortcuts (Unchanged)

Ctrl+B, Ctrl+I, Ctrl+U, Ctrl+Z, Ctrl+Y continue to work with ribbon

## Error Handling

- Canvas not supported: fall back to contenteditable only (warn user)
- Font metrics unavailable: use monospace defaults
- Margin calculations fail: disable margin enforcement (log error)

## Performance Considerations

- Debounce canvas redraws (50ms after typing stops)
- Only redraw visible lines (viewport culling)
- Cache font metrics and line positions
- Use requestAnimationFrame for smooth scrolling

## Testing

1. Open .txt file → should auto-open with canvas editor
2. Right-click .txt → "Reopen With" shows plain text editor option
3. Type text → wraps at right margin automatically
4. Ruler shows correct character positions
5. Left margin shows line numbers
6. Ribbon formatting still works
7. Canvas renders text matching contenteditable

## Future Enhancements (TODO comments added)

- Insert tab: Tables, images, shapes, charts
- Page Layout tab: Page size, columns, orientation
- Review tab: Track changes, comments, spell check
- View tab: Zoom, ruler units (inches/cm), page breaks

### To-dos

- [x] Change priority to 'default' in package.json
- [x] Add canvas element and layering structure
- [x] Create canvasRenderer.ts with text drawing
- [x] Create rulerManager.ts for rulers and margins
- [x] Create marginController.ts for text constraints
- [x] Integrate canvas with existing ribbon editor
- [x] Add TODO comments for future ribbon tabs
- [x] Test that .txt files auto-open with new editor